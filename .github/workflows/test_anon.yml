name: Test Anon

on: 
  workflow_dispatch:
  
jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Setup golang version
      uses: actions/setup-go@v3
      with:
        go-version: '1.20'

    - name: Initialization environment
      run: |
        sudo apt-get update
        sudo apt install upx git -y

    - name: Clone&Build xray source code
      run: |
        git clone --depth=1 https://github.com/xtls/xray-core.git xray-core
        cd xray-core/main
        #GOOS=linux GOARCH=mipsle go build -o ../../xraybin/xray
        GOOS=linux GOARCH=mipsle go build -o ../../xraybin/xray -trimpath -ldflags "-s -w -buildid=" ./
        cd ../../xraybin
        upx -9 xray
        shopt -s extglob
        rm -vrf !("xray")
        echo "xray=$PWD" >> $GITHUB_ENV
        echo "STATUS=success" >> $GITHUB_ENV

    - name: Upload firmware to Anonfile
      if: env.STATUS == 'success'
      run: |
        #curl -fsSL git.io/file-transfer | sh
        ./transfer anon --no-progress ${xray} 2>&1 | tee anonfile.log
        #curl -F "file=@${xray}" https://api.anonfiles.com/upload > anonfile.log
        cat anonfile.log
        echo "$(cat anonfile.log)"
        echo "::warning file=anonfile.com::$(cat anonfile.log | grep -o -E "https?://[a-zA-Z0-9\.\/_&=@$%?~#-]*")"
        #echo "WETRANSFER_URL=$(cat wetransfer.log | grep -o -E "https?://[a-zA-Z0-9\.\/_&=@$%?~#-]*")" >> $GITHUB_ENV
